name: Pull Request
on: pull_request

permissions: read-all

jobs:
  tests:
    runs-on: ubuntu-latest
    name: Compute Impacted Targets Tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bazel
        # trunk-ignore(semgrep): Trust third-party `bazel-contrib` GH Action
        uses: bazel-contrib/setup-bazel@0.18.0

      - name: Compute Impacted Targets
        id: compute
        run: ./src/scripts/compute_impacted_targets.sh
        shell: bash
        env:
          MERGE_INSTANCE_BRANCH: do_not_delete/test-branch-021226
          MERGE_INSTANCE_BRANCH_HEAD_SHA: bce634a9385344a379c0871c3c92f116f3f284b2
          PR_BRANCH: do_not_delete/test-branch-021226
          PR_BRANCH_HEAD_SHA: 50c0d2d529308aa7784bec0c666208ed437da93c
          VERBOSE: 1
          WORKSPACE_PATH: ./tests/bazel8
          BAZEL_STARTUP_OPTIONS: --host_jvm_args=-Xmx12G,--block_for_lock,--client_debug
          BAZEL_PATH: bazel

      - name: Validate Impacted Targets Computation
        shell: bash
        env:
          MERGE_INSTANCE_BRANCH_HEAD_SHA: 6f91712082f791d025fda81b67a8b0569fd01025
          PR_BRANCH_HEAD_SHA: bce634a9385344a379c0871c3c92f116f3f284b2
        run: |
          impacted_targets_file="${{ steps.compute.outputs.impacted_targets_out }}"
          target_count=$(wc -l < "$impacted_targets_file")
          echo "=== Impacted targets (count=$target_count) ==="
          cat "$impacted_targets_file"
          echo "=== End of impacted targets ==="
          # When base and PR are the same SHA, expect 0 targets. When different, we expect some.
          if [[ "$MERGE_INSTANCE_BRANCH_HEAD_SHA" == "$PR_BRANCH_HEAD_SHA" ]]; then
            if [[ $target_count -ne 0 ]]; then
              echo "Expected 0 impacted targets (same SHA) but got $target_count"
              exit 1
            fi
          fi
